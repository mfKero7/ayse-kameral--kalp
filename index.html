<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>AyÅŸe'nin Kalp AvÄ±</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: #000; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            touch-action: none; /* Tablette kaydÄ±rmayÄ± engelle */
        }
        canvas { 
            display: block; 
            width: 100vw; 
            height: 100vh; 
            object-fit: cover;
        }
        #ui-container {
            position: absolute; 
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* TÄ±klamalarÄ± engelle */
        }
        #score-box { 
            position: absolute;
            top: 30px; 
            width: 100%; 
            text-align: center; 
            color: #ff4757; 
            font-size: 50px; 
            font-weight: 900;
            text-shadow: 2px 2px 0 #fff, -2px -2px 0 #fff, 2px -2px 0 #fff, -2px 2px 0 #fff; /* KalÄ±n beyaz Ã§erÃ§eve */
        }
        #milestone-message {
            position: absolute;
            top: 50%;
            width: 100%;
            text-align: center;
            font-size: 60px;
            color: gold;
            font-weight: bold;
            text-shadow: 0 0 20px orange;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        /* UÃ§uÅŸan +1 efekti iÃ§in stil */
        .floating-text {
            position: absolute;
            color: white;
            font-size: 30px;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            text-shadow: 0 0 5px red;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }
    </style>
</head>
<body>
    <video id="webcam" style="display:none;" autoplay playsinline></video>
    <canvas id="gameCanvas"></canvas>

    <div id="ui-container">
        <div id="score-box">Skor: <span id="score">0</span></div>
        <div id="milestone-message"></div>
    </div>

    <audio id="popSound" src="pop.mp3" preload="auto"></audio>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('gameCanvas');
        const canvasCtx = canvasElement.getContext('2d');
        const scoreElement = document.getElementById('score');
        const popSound = document.getElementById('popSound');
        const milestoneMsg = document.getElementById('milestone-message');

        let score = 0;
        let heartX = 200;
        let heartY = 200;
        const heartSize = 120; // Kalbi biraz bÃ¼yÃ¼ttÃ¼m iPad iÃ§in
        let lastTouchTime = 0; // PeÅŸ peÅŸe Ã§arpmalarÄ± engellemek iÃ§in
        const heartImg = new Image();
        heartImg.src = 'kalp.png'; 

        canvasElement.width = window.innerWidth;
        canvasElement.height = window.innerHeight;

        // Pencere boyutu deÄŸiÅŸirse canvasÄ± ayarla (iPad'i Ã§evirirse diye)
        window.addEventListener('resize', () => {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            moveHeart();
        });

        function moveHeart() {
            // Kenarlara Ã§ok yapÄ±ÅŸmasÄ±n diye margin bÄ±raktÄ±m
            const margin = 50;
            heartX = margin + Math.random() * (canvasElement.width - heartSize - margin*2);
            heartY = margin + Math.random() * (canvasElement.height - heartSize - margin*2);
        }

        // UÃ§uÅŸan +1 yazÄ±sÄ± oluÅŸturma fonksiyonu
        function createFloatingText(x, y) {
            const floatingTxt = document.createElement('div');
            floatingTxt.className = 'floating-text';
            floatingTxt.innerText = '+1';
            floatingTxt.style.left = x + 'px';
            floatingTxt.style.top = y + 'px';
            document.getElementById('ui-container').appendChild(floatingTxt);
            
            // 1 saniye sonra sil
            setTimeout(() => {
                floatingTxt.remove();
            }, 1000);
        }

        // AyÅŸe'ye Ã¶zel mesaj gÃ¶sterme
        function showMilestoneMessage(msg) {
            milestoneMsg.innerText = msg;
            milestoneMsg.style.opacity = 1;
            setTimeout(() => {
                 milestoneMsg.style.opacity = 0;
            }, 2000); // 2 saniye ekranda kalsÄ±n
        }

        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // Ayna modu
            canvasCtx.translate(canvasElement.width, 0);
            canvasCtx.scale(-1, 1);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            let isTouching = false; // Bu karede temas var mÄ±?

            if (results.multiHandLandmarks) {
                for (const landmarks of results.multiHandLandmarks) {
                    const indexFinger = landmarks[8];
                    const x = (1 - indexFinger.x) * canvasElement.width; 
                    const y = indexFinger.y * canvasElement.height;

                    // Ã‡arpÄ±ÅŸma KontrolÃ¼
                    if (x > heartX && x < heartX + heartSize && y > heartY && y < heartY + heartSize) {
                        isTouching = true;
                    }
                }
            }

            // EÄŸer temas varsa ve son temastan beri 300ms geÃ§tiyse (spam'i Ã¶nlemek iÃ§in)
            const currentTime = Date.now();
            if (isTouching && (currentTime - lastTouchTime > 300)) {
                score++;
                scoreElement.innerText = score;
                lastTouchTime = currentTime;
                
                // --- EFEKTLER BURADA ---
                
                // 1. Ses Ã‡al (Hata verirse oyunu durdurma)
                try {
                    popSound.currentTime = 0; // Sesi baÅŸa sar
                    popSound.play();
                } catch (e) { console.log("Ses Ã§alÄ±namadÄ± (tarayÄ±cÄ± engeli olabilir)."); }

                // 2. UÃ§uÅŸan yazÄ±yÄ± Ã§Ä±kar
                createFloatingText(heartX + heartSize/2, heartY);

                // 3. Kalbi taÅŸÄ±
                moveHeart();

                // 4. Ã–zel Mesajlar
                if (score === 10) showMilestoneMessage("HarikasÄ±n AyÅŸe! IsÄ±nÄ±yorsun ðŸ”¥");
                if (score === 25) showMilestoneMessage("AYÅžE ALEV ALDI!! ðŸ”¥â¤ï¸â€ðŸ”¥");
        
            }
            
            canvasCtx.restore();
            canvasCtx.drawImage(heartImg, heartX, heartY, heartSize, heartSize);
        }

        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 1280,
            height: 720
        });
        camera.start();
    </script>
</body>
</html>
